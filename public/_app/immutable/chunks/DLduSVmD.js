const w="pulse-demo-data";function c(){return Math.floor(Date.now()/1e3)}function I(){return Math.random().toString(36).slice(2,10)}function l(){const e=localStorage.getItem(w);if(e)return JSON.parse(e);const o=k();return p(o),o}function p(e){localStorage.setItem(w,JSON.stringify(e))}function u(){return localStorage.getItem("pulse-user")||sessionStorage.getItem("pulse-user")||"anonymous"}function k(){const e=c();return{users:{demo:{username:"demo",email:"demo@pulse.app",passwordHash:"demo",salt:"",verified:!0,createdAt:e},alice:{username:"alice",email:"alice@pulse.app",passwordHash:"alice",salt:"",verified:!0,createdAt:e},bob:{username:"bob",email:"bob@pulse.app",passwordHash:"bob",salt:"",verified:!0,createdAt:e}},emails:{"demo@pulse.app":"demo","alice@pulse.app":"alice","bob@pulse.app":"bob"},polls:[{pollId:"techstack",question:"What should we use for our next internal tool?",description:"We need a lightweight frontend framework for a dashboard project",questionLink:"https://2024.stateofjs.com/en-US/libraries/front-end-frameworks/",options:["React","Svelte","Vue","HTMX"],optionLinks:["https://react.dev","https://svelte.dev","https://vuejs.org","https://htmx.org"],creator:"demo",status:"active",createdAt:e-3600,expiresAt:e+86400,deletesAt:e+15552e3,anonCreator:!1,anonVoters:!1,visibleVoters:!0,private:!1},{pollId:"lunch",question:"Where should we order lunch from on Friday?",description:"Budget is $15 per person, needs vegetarian options",questionLink:null,options:["Chipotle","Sweetgreen","Cava"],optionLinks:["https://www.chipotle.com/menu","https://www.sweetgreen.com/menu","https://cava.com/menu"],creator:"alice",status:"active",createdAt:e-7200,expiresAt:e+172800,deletesAt:e+15552e3,anonCreator:!1,anonVoters:!1,visibleVoters:!1,private:!1},{pollId:"spirit",question:"What's your spirit animal at work?",description:"Be honest. No judgment.",questionLink:null,options:["Coffee addict â˜•","Procrastinator supreme ðŸ¦¥","Meeting survivor ðŸ“…","Slack lurker ðŸ‘€","Keyboard warrior âŒ¨ï¸"],optionLinks:[null,null,null,null,null],creator:"demo",status:"active",createdAt:e-1800,expiresAt:e+604800,deletesAt:e+15552e3,anonCreator:!0,anonVoters:!0,visibleVoters:!1,private:!1},{pollId:"hackathon",question:"What should our next hackathon theme be?",description:"2-day event in March, teams of 3-5",questionLink:"https://en.wikipedia.org/wiki/Hackathon",options:["AI/ML tools","Developer productivity","Sustainability","Open source"],optionLinks:["https://huggingface.co","https://github.com/features/copilot","https://www.thegreenwebfoundation.org","https://opensource.guide"],creator:"bob",status:"active",createdAt:e-600,expiresAt:e+259200,deletesAt:e+15552e3,anonCreator:!1,anonVoters:!1,visibleVoters:!0,private:!1},{pollId:"private1",question:"Should we switch to 4-day work weeks?",description:"Confidential team survey â€” link only",questionLink:null,options:["Yes, absolutely","Maybe, trial first","No, keep 5 days"],optionLinks:[null,null,null],creator:"demo",status:"active",createdAt:e-900,expiresAt:e+604800,deletesAt:e+15552e3,anonCreator:!1,anonVoters:!0,visibleVoters:!1,private:!0}],votes:[{pollId:"techstack",alias:"demo",option:"Svelte"},{pollId:"techstack",alias:"alice",option:"Svelte"},{pollId:"techstack",alias:"bob",option:"React"},{pollId:"techstack",alias:"carol",option:"Svelte"},{pollId:"techstack",alias:"dave",option:"HTMX"},{pollId:"lunch",alias:"demo",option:"Sweetgreen"},{pollId:"lunch",alias:"bob",option:"Chipotle"},{pollId:"lunch",alias:"carol",option:"Cava"},{pollId:"lunch",alias:"dave",option:"Chipotle"},{pollId:"spirit",alias:"alice",option:"Coffee addict â˜•"},{pollId:"spirit",alias:"bob",option:"Slack lurker ðŸ‘€"},{pollId:"spirit",alias:"carol",option:"Procrastinator supreme ðŸ¦¥"},{pollId:"spirit",alias:"demo",option:"Keyboard warrior âŒ¨ï¸"},{pollId:"hackathon",alias:"alice",option:"AI/ML tools"},{pollId:"hackathon",alias:"carol",option:"Open source"},{pollId:"hackathon",alias:"dave",option:"AI/ML tools"},{pollId:"hackathon",alias:"demo",option:"Developer productivity"},{pollId:"private1",alias:"demo",option:"Maybe, trial first"},{pollId:"private1",alias:"alice",option:"Yes, absolutely"},{pollId:"private1",alias:"bob",option:"Yes, absolutely"}]}}function v(e,o,t){const s=o.filter(r=>r.pollId===e.pollId),a={},n={};let d=null;for(const r of e.options)a[r]=0,n[r]=[];for(const r of s)a[r.option]=(a[r.option]||0)+1,!e.anonVoters&&e.visibleVoters&&n[r.option].push(r.alias),r.alias===t&&t!=="anonymous"&&(d=r.option);const m=e.options.map((r,h)=>{const f={option:r,count:a[r]||0};return e.optionLinks?.[h]&&(f.link=e.optionLinks[h]),!e.anonVoters&&e.visibleVoters&&(f.voters=n[r]),f});return{pollId:e.pollId,question:e.question,description:e.description,questionLink:e.questionLink,options:e.options,results:m,totalVotes:s.length,status:e.status,createdAt:e.createdAt,startsAt:e.startsAt||null,expiresAt:e.expiresAt,deletesAt:e.deletesAt,anonCreator:e.anonCreator,anonVoters:e.anonVoters,visibleVoters:e.visibleVoters,private:e.private,myVote:d,creator:e.anonCreator?"Anonymous":e.creator,isOwner:e.creator===t}}function i(e=150){return new Promise(o=>setTimeout(o,e))}const g={async signup({username:e,email:o,password:t}){await i();const s=l();if(s.users[e])throw new Error("Username already taken");if(s.emails[o])throw new Error("Email already registered");return s.users[e]={username:e,email:o,passwordHash:t,salt:"",verified:!1,verifyCode:"123456",createdAt:c()},s.emails[o]=e,p(s),{message:"Verification code sent",email:o}},async verify({email:e,code:o}){await i();const t=l(),s=t.emails[e];if(!s)throw new Error("Email not found");const a=t.users[s];if(o.length!==6)throw new Error("Invalid code");return a.verified=!0,delete a.verifyCode,p(t),{token:`demo-token-${s}`,username:s}},async resend({email:e}){return await i(),{message:"New code sent"}},async signin({email:e,password:o}){await i();const t=l(),s=t.emails[e];if(!s)throw new Error("Invalid email or password");const a=t.users[s];if(!a.verified)throw new Error("Email not verified");if(a.passwordHash!==o)throw new Error("Invalid email or password");return{token:`demo-token-${s}`,username:s}},async forgot({email:e}){return await i(),{message:"If that email is registered, a reset code has been sent"}},async resetPassword({email:e,code:o,password:t}){await i();const s=l(),a=s.emails[e];if(!a)throw new Error("Invalid code");return s.users[a].passwordHash=t,p(s),{token:`demo-token-${a}`,username:a}},async me(){await i(50);const e=u();if(e==="anonymous")throw new Error("Not authenticated");return{username:e}},async createPoll(e){await i();const o=l(),t={pollId:I(),question:e.question,description:e.description||null,questionLink:e.questionLink||null,options:e.options,optionLinks:e.optionLinks||[],creator:u(),status:e.startsAt&&e.startsAt>c()?"scheduled":"active",createdAt:c(),startsAt:e.startsAt||null,expiresAt:e.endsAt||c()+86400,deletesAt:c()+15552e3,anonCreator:!!e.anonCreator,anonVoters:!!e.anonVoters,visibleVoters:!!e.visibleVoters,private:!!e.private};return o.polls.unshift(t),p(o),{pollId:t.pollId}},async getPolls(e="recent",o=""){await i();const t=l(),s=u();let a=t.polls;return e==="mine"?a=a.filter(n=>n.creator===s):a=a.filter(n=>!n.private),{polls:a.map(n=>({...v(n,t.votes,s),totalVotes:t.votes.filter(d=>d.pollId===n.pollId).length})),nextCursor:null}},async getPoll(e){await i();const o=l(),t=o.polls.find(s=>s.pollId===e);if(!t)throw new Error("Poll not found");return v(t,o.votes,u())},async closePoll(e){await i();const o=l(),t=o.polls.find(s=>s.pollId===e);if(!t)throw new Error("Poll not found");return t.status=t.status==="closed"?"active":"closed",p(o),{status:t.status}},async editPoll(e,o){await i();const t=l(),s=t.polls.find(n=>n.pollId===e);if(!s)throw new Error("Poll not found");const a=JSON.stringify(o.options)!==JSON.stringify(s.options);return s.question=o.question,s.description=o.description||null,s.questionLink=o.questionLink||null,s.options=o.options,s.optionLinks=o.optionLinks||[],a&&(t.votes=t.votes.filter(n=>n.pollId!==e)),p(t),{edited:!0,votesReset:a}},async deletePoll(e){await i();const o=l();return o.polls=o.polls.filter(t=>t.pollId!==e),o.votes=o.votes.filter(t=>t.pollId!==e),p(o),{deleted:!0}},async vote(e,o){await i();const t=l(),s=u(),a=t.votes.find(n=>n.pollId===e&&n.alias===s);return a&&a.option===o?(t.votes=t.votes.filter(n=>!(n.pollId===e&&n.alias===s)),p(t),{voted:null}):(t.votes=t.votes.filter(n=>!(n.pollId===e&&n.alias===s)),t.votes.push({pollId:e,alias:s,option:o}),p(t),{voted:o})}};export{g as api};
